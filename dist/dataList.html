<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Set</title>
    <!-- Style Sheets -->
    <link href='https://fonts.googleapis.com/css?family=Poppins' rel='stylesheet'>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <link rel="stylesheet" href="./css/dashstyle.css">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    
    <!-- Bundle.js Script -->
    <script defer src="bundle.js"> </script>
    
    <!-- Bootstrap and Icons -->
    <script src="https://kit.fontawesome.com/334c45a40c.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js" integrity="sha384-oBqDVmMz9ATKxIep9tiCxS/Z9fNfEXiDAYTujMAeBAsjFuCZSmKbSSUnQlmh/jp3" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.min.js" integrity="sha384-cuYeSxntonz0PPNlHhBs68uyIAVpIIOZZ5JqeqvYYIcEL727kskC66kF92t6Xl2V" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>
    
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
    
    
    <!-- jQuery, Popper.js, Bootstrap JS -->
    <script src="js/jquery-3.3.1.slim.min.js"></script>
    <script src="js/popper.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/jquery-3.3.1.min.js"></script>
    
    <!-- Firebase Data to DataTables -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/dt/dt-1.10.25/datatables.min.css" />
    <script type="text/javascript" src="https://cdn.datatables.net/v/dt/dt-1.10.25/datatables.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.2/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.2/firebase-firestore.js"></script>
    
    <!-- jQuery , DataTables , Bootstrap CSS , css3 -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.25/css/jquery.dataTables.min.css">
    <script src="https://cdn.datatables.net/1.10.25/js/jquery.dataTables.min.js"></script>
    
    <link rel="stylesheet" href="css/bootstrap.min.css">
    
    <link rel="stylesheet" href="css/custom.css">
    
    <!-- SLIDER REVOLUTION 4.x CSS SETTINGS -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&display=swap" rel="stylesheet">

    <!--google material icon-->
    <link href="https://fonts.googleapis.com/css2?family=Material+Icons" rel="stylesheet">
        
</head>
<body>
    <div class = "main-container">
        <div class="navigation">
            <ul>
                <li>
                    <a href="dashBoard.html">
                        <span class="icon"><ion-icon name="flash-outline"></ion-icon></span>
                        <span class="title">Wattsapp</span>
                    </a>
                </li>
                <li>
                    <a href="dashBoard.html">
                        <span class="icon"><ion-icon name="home-outline"></ion-icon></span>
                        <span class="title">Dashboard</span>
                    </a>
                </li>
                <li>
                    <a href="analytics.html">
                        <span class="icon"><ion-icon name="stats-chart-outline"></ion-icon></span>
                        <span class="title">Visualization</span>
                    </a>
                </li>
                <li>
                    <a href="#">
                        <span class="icon"><ion-icon name="file-tray-full-outline"></ion-icon></ion-icon></span>
                        <span class="title">Data Set</span>
                    </a>
                </li>
                <li>
                    <a href="#" id="logout">
                        <span class="icon" ><ion-icon name="log-out-outline"></ion-icon></span>
                        <span class="title">Sign Out</span>
                    </a>
                </li>
            </ul>
        </div>

        <!-- main -->
        <div class="main">
            <div class="topbar">
                <div class="toggle">
                    <ion-icon name="menu-outline"></ion-icon>
                </div>
                
                <!-- userImg -->
                <div class="user">
                    <img src="img/profile.png">
                </div>
            </div>

            <div class="details">
                <!-- Order details list -->
                <div class="recentOrders">
                    <div class="cardHeader">
                        <h2> Energy Consumption Record</h2>
                        <div class="row mb-3">
                            <div class="col-auto">
                              <button id="add-btn" type="button" class="btn btn-success add-btn" data-bs-toggle="modal"
                                data-bs-target="#add-modal">
                                <i class="fa-solid fa-square-plus"></i> Add Data
                              </button>
                            </div>
                        </div>
                    </div>

                    <table id="myTable" class="display">
                        <thead>
                          <tr>
                            <th>No. </th>
                            <th>Appliance</th>
                            <th>Floor</th>
                            <th>Room </th>
                            <th>Energy Consumption </th>
                            <th>Date Time</th>
                            <th>Action</th>
                          </tr>
                        </thead>
                        <tbody>
                        </tbody>
                      </table>
                    </table>
                    
                    <!-- Add Modal -->
                    <div id="add-modal" class="modal" tabindex="-1">
                        <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                            <h5 class="modal-title">Add Data</h5>
                            <button type="button" id="close" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                            <div class="form-row">
                                <form>
                                <div class="form-group col-md-12">
                                    <label for="ApplianceName" class="form-label" required>Appliance:</label>
                                    <input type="text" class="form-control" id="ApplianceName" required style="width: 100%;">
                                </div>
                                <div class="form-group col-md-7">
                                    <label for="Floor" class="form-label" required>Floor:</label>
                                    <div class="input-group">
                                    <input type="text" class="form-control" id="Floor" required>
                                    </div>
                                    <label for="Room" class="form-label" required>Room:</label>
                                    <div class="input-group">
                                    <input type="text" class="form-control" id="Room" required>
                                    </div>
                                    <label for="Energy" class="form-label" required>Energy Consumption:</label>
                                    <div class="input-group">
                                    <input type="number" class="form-control" id="Energy" required>
                                    <span class="input-group-text">kWh</span>
                                    </div>
                                    
                                </div>
                                <div class="form-group col-md-10">
                                    <label for="DateTime" class="form-label">Date and Time:</label>
                                    <input type="datetime-local" class="form-control" id="DateTime" required>
                                </div>
                                </form>
                            </div>
                            </div>
                            <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" id="add-button">Add</button>
                            </div>
                        </div>
                        </div>
                    </div>
                    <!-- Edit Modal -->
                    <div id="edit-modal" class="modal" tabindex="-1">
                        <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                            <h5 class="modal-title">Edit Data</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"
                                id="edit-close"></button>
                            </div>
                            <div class="modal-body">
                            <form>
                                <div class="form-group col-md-7">
                                <label for="ApplianceName" class="form-label" required>Appliance:</label>
                                <input type="text" class="form-control" id="applianceNameInput" required style="width: 100%;">
                                </div>
                                <div class="form-group col-md-4">
                                    <label for="Floor" class="form-label" required>Floor:</label>
                                    <div class="input-group">
                                    <input type="text" class="form-control" id="floorInput" required>
                                    </div>

                                    <label for="Room" class="form-label" required>Room:</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="roomInput" required>
                                    </div>

                                    <label for="Energy" class="form-label" required>Energy Consumption:</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="energyConsumptionInput" required>
                                        <span class="input-group-text">kWh</span>
                                    </div>
                                </div>
                                <div class="form-group col-md-6">
                                <label for="DateTime" class="form-label">Edit Date and Time:</label>
                                <input type="datetime-local" class="form-control" id="DateTimeInput">
                                </div>
                                <div class="form-group col-md-6">
                                <label for="DateTime" class="form-label">Current Date and Time</label>
                                <input type="text" class="form-control" id="DateTimeValue" readonly>
                                </div>
                            </form>
                            </div>
                            <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"
                                id="edit-close-button">Close</button>
                            <button type="button" class="btn btn-primary" id="update-button">Save</button>
                            </div>
                        </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
    <script>
        // menu toggle
        let toggle = document.querySelector('.toggle');
        let navigation = document.querySelector('.navigation');
        let main = document.querySelector('.main');
        
        toggle.onclick = function(){
            navigation.classList.toggle('active')
            main.classList.toggle('active')
        }

        //add hovered class in selected list item
        let list = document.querySelectorAll('.navigation li');
        function activeLink(){
            list.forEach((item) =>
            item.classList.remove('hovered'));
            this.classList.add('hovered');
        }
        list.forEach((item) =>
        item.addEventListener('mouseover',activeLink));
    </script>

     <!-- firebase js -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.18.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.18.0/firebase-analytics.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut} from "https://www.gstatic.com/firebasejs/9.18.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, connectFirestoreEmulator, query, getDocs, getDoc, updateDoc, setDoc, doc, onSnapshot, deleteDoc, orderBy } from 'https://www.gstatic.com/firebasejs/9.18.0/firebase-firestore.js';

        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries

        // Your web app's Firebase configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
        apiKey: "AIzaSyDu1H0GkJn1nEHG2k2ncAXq3vp20ztDdiY",
        authDomain: "wattsapp-34e56.firebaseapp.com",
        projectId: "wattsapp-34e56",
        storageBucket: "wattsapp-34e56.appspot.com",
        messagingSenderId: "993603022763",
        appId: "1:993603022763:web:51635c05053022b5072cee",
        measurementId: "G-HTMJT0D0FJ"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth();
        console.log(app);

        //Firestore
        const db = getFirestore(app);

        //DataTables
        firebase.initializeApp(firebaseConfig);
        const db2 = firebase.firestore();  // Function for Database Firestore 

        function updateSuccess() {
        Swal.fire({
            title: "Success",
            text: "Record updated successfully",
            icon: "success",
        });
        }

        function updateError(errorMessage) {
        Swal.fire({
            title: "Error",
            text: `There was an error updating the record: ${errorMessage}`,
            icon: "error",
        });
        }

        // Get the data from Firestore and add it to the DataTable
        db2.collection("RoomRecords")
        .orderBy("DateTime", "desc")
        .onSnapshot(
            (querySnapshot) => {
            let counter = 1; // initialize counter variable
            let updateCount = 0; // initialize update counter 
            const table = $('#myTable').DataTable(); // cache DataTable instance
            table.clear(); // clear existing data in the table
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                const dateTime = data["DateTime"];
                const date = new Date(dateTime.toDate()).toLocaleDateString();
                const time = new Date(dateTime.toDate()).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                // Edit Button             
                const editButton = `<button type="button" class="btn btn-warning btn-sm edit" data-id="${doc.id}-edit" data-appliancename="${data['Appliance Name']}" data-room="${data['Room Name']}" data-energyconsumption="${data['Energy Consumption'].replace('kWh', '')}" data-datetime="${dateTime.toDate()}">Edit</button>`;
                // Delete Button
                const deleteButton = `<button type="button" class="btn btn-danger btn-sm delete" data-id="${doc.id}-delete"><ion-icon name="trash-outline"></ion-icon></button>`;

                // Add event listener for update button
                $(document).off('click', '#update-button').on('click', '#update-button', function () {
                const docId = $(this).data('id');
                const appliancename = $('#applianceNameInput').val();
                const floor = $('#floorInput').val();
                const roomName = $('#roomInput').val();
                const energyConsumption = $('#energyConsumptionInput').val() + 'kWh';
                const dateTime = new Date($('#DateTimeValue').val());
                const newData = {
                    'Appliance Name': applianceName,
                    'Floor' : floor,
                    'Room Name': roomName,
                    'Energy Consumption': energyConsumption,
                    'DateTime': firebase.firestore.Timestamp.fromDate(dateTime) // Fix: can't update time yet will fix soon
                };
                console.log('Updating docId:', docId); // Check if Document ID matches with docID
                db2.collection("RoomRecords").doc(docId).update(newData) // update only the specific document
                    .then(() => {
                    console.log("update success");
                    $('#edit-modal').modal('hide');
                    updateSuccess();
                    $(this).off('click'); // Remove event listener after update is completed
                    })
                    .catch((error) => {
                    console.error("Error updating record: ", error);
                    console.log("Error message: ", error.message);
                    updateError(error.message);
                    });
                });


                // Add event listener for edit button
                $(document).on('click', '.edit', function () {
                if ($(this).data('id') === `${doc.id}-edit`) {
                    console.log(`Editing document with ID: ${doc.id}`); // add this line
                    const docId = $(this).data('id').replace('-edit', '');
                    const applianceName = $(this).data('appliancename');
                    const floor = $(this).data('floorInput');
                    const roomName = $(this).data('room');
                    const energyConsumption = $(this).data('energyconsumption');
                    const dateTime = $(this).data('datetime');
                    // Pass data to edit form and display it
                    $('#applianceNameInput').val(applianceName);
                    $('#floorInput').val(floor);
                    $('#roomInput').val(roomName);
                    $('#energyConsumptionInput').val(energyConsumption);
                    const date = new Date(dateTime).toLocaleDateString();
                    const time = new Date(dateTime).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    $('#DateTimeValue').val(`${date} ${time}`);
                    $('#edit-modal').modal('show');
                    $('#update-button').data('id', docId);
                }
                });

                // Add event listener for delete button
                $(document).on('click', '.delete', function () {
                if ($(this).data('id') === `${doc.id}-delete`) {
                    Swal.fire({
                    title: "Are you sure?",
                    text: `Do you really want to delete the record for ${data["Appliance Name"]}?`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'Yes, delete it!'
                    }).then((result) => {
                    if (result.isConfirmed) {
                        db2.collection("RoomRecords").doc(doc.id).delete()
                        .then(() => {
                            console.log("Successful Delete")
                            Swal.fire({
                            title: "Deleted!",
                            text: `The record for ${data["Appliance Name"]} has been deleted`,
                            icon: "success",
                            });
                            table.row($(this).closest('tr')).remove().draw(); // remove row from DataTable
                        })
                        .catch((error) => {
                            console.error("Error removing record: ", error);
                            Swal.fire({
                            title: "Error",
                            text: "There was an error removing the record.",
                            icon: "error",
                            });
                        });
                    }
                    });
                }
                });

                // Displays the Data to the Tables
                table.row.add([
                counter++, // increment counter variable and include as first column
                data["Appliance Name"],
                data["Floor"],
                data["Room Name"],
                data["Energy Consumption"],
                `${date} ${time}`,
                `${editButton} ${deleteButton}`
                ]);

            });
            table.draw(); // refresh the table with new data
            },
            (error) => {
            console.log(`Error getting documents: ${error}`);
            }
        );



        // <----- ADD MODAL -----> 

        // Get the add modal element from the DOM
        const addModal = document.getElementById("add-modal");

        // Get the input fields and buttons from the add modal
        const addAppliancenameInput = addModal.querySelector("#ApplianceName");
        const addFloorInput = addModal.querySelector("#Floor");
        const addRoomnameInput = addModal.querySelector("#Room");
        const addEnergyconsumptionInput = addModal.querySelector("#Energy"); // <--- fixed typo
        const addDatetimeInput = addModal.querySelector("#DateTime");
        const addButton = addModal.querySelector("#add-button");
        const cancelButton = addModal.querySelector("#cancel-button");

        // Add event listener to the add button
        addButton.addEventListener("click", () => {
        const ApplianceName = addAppliancenameInput.value.trim();
        const Floor = addFloorInput.value.trim();
        const Room = addRoomnameInput.value.trim();
        const Energy = addEnergyconsumptionInput.value.trim();
        const DateTime = new Date(addDatetimeInput.value.trim());

        // Check if any of the input fields are blank
        if (!ApplianceName || !Floor || !Room || !Energy || !DateTime) {
            Swal.fire({
            icon: "error",
            title: "Error",
            text: "Please Fill Out All The Fields"
            });
            return;
        }

        // Add the data to Firestore
        addDoc(collection(db, "RoomRecords"), {
            "Appliance Name": ApplianceName,
            "Floor": Floor,
            "Room Name": Room,
            "Energy Consumption": Energy + "kWh",
            "DateTime": DateTime
        })
            .then((docRef) => {
            console.log("Document written with ID: ", docRef.id);
            })
            .catch((error) => {
            console.error("Error adding document: ", error);
            });

        // Reset the input fields
        addAppliancenameInput.value = "";
        addFloorInput.value = "";
        addRoomnameInput.value = "";
        addEnergyconsumptionInput.value = "";
        addDatetimeInput.value = "";

        function hideAddModal() {
            const addModal = new bootstrap.Modal(document.querySelector("add-modal"));
            const modalBackdrop = document.querySelector('.modal-backdrop');

            // Hide the modal
            addModal.hide();

            // Remove the backdrop
            modalBackdrop.parentNode.removeChild(modalBackdrop);
        }

        // Show a success message
        Swal.fire({
            icon: "success",
            title: "Data Added Successfully",
            text: "You can either close this modal or add more data"
        });
        });

        // Add event listener to the add modal to reset the input fields
        addModal.addEventListener("hidden.bs.modal", () => {
        addAppliancenameInput.value = "";
        addFloorInput.value = "";
        addRoomnameInput.value = "";
        addEnergyconsumptionInput.value = "";
        addDatetimeInput.value = "";
        });

        // Logout	  
        document.getElementById("logout").addEventListener("click", function () {
        signOut(auth).then(() => {
            // Sign-out successful.
            console.log('Sign-out successful.');
            (Swal.fire({
            icon: 'success',
            title: 'Logged Out Successfully',
            }));
            setTimeout(function () {
            window.location.href = "index.html";
            }, 2000);
        }).catch((error) => {
            // Error Occured.
            console.log('An error happened.');
            (Swal.fire({
            icon: 'error',
            title: 'An Error Has Occured',
            text: '' + error,
            }));;
        });
        });

        </script>

        <!-- Data Table Show Entries -->
        <script>
        $('#myTable').dataTable({
        "lengthMenu": [[5, 15, 30, -1], [5, 15, 30, "All"]]
        });
        </script>
    </script>
</body>
</html>